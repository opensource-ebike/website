"use strict";(self.webpackChunkdocusaurus=self.webpackChunkdocusaurus||[]).push([[9776],{3905:function(e,t,n){n.d(t,{Zo:function(){return d},kt:function(){return h}});var o=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},l=Object.keys(e);for(o=0;o<l.length;o++)n=l[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(o=0;o<l.length;o++)n=l[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=o.createContext({}),u=function(e){var t=o.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},d=function(e){var t=u(e.components);return o.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},c=o.forwardRef((function(e,t){var n=e.components,a=e.mdxType,l=e.originalType,s=e.parentName,d=i(e,["components","mdxType","originalType","parentName"]),c=u(n),h=a,m=c["".concat(s,".").concat(h)]||c[h]||p[h]||l;return n?o.createElement(m,r(r({ref:t},d),{},{components:n})):o.createElement(m,r({ref:t},d))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var l=n.length,r=new Array(l);r[0]=c;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"==typeof e?e:a,r[1]=i;for(var u=2;u<l;u++)r[u]=n[u];return o.createElement.apply(null,r)}return o.createElement.apply(null,n)}c.displayName="MDXCreateElement"},8221:function(e,t,n){n.r(t),n.d(t,{assets:function(){return d},contentTitle:function(){return s},default:function(){return h},frontMatter:function(){return i},metadata:function(){return u},toc:function(){return p}});var o=n(3117),a=n(102),l=(n(7294),n(3905)),r=["components"],i={},s="Configure Code Studio IDE for firmware development, flash and debug",u={unversionedId:"display/development/development-flash_and_debug_firmware",id:"display/development/development-flash_and_debug_firmware",title:"Configure Code Studio IDE for firmware development, flash and debug",description:"For the firmware development, flash and debug, you can use the OpenSource and free IDE Visual Studio Code. There are others that will work like the Eclipse but are not the focus of this document.",source:"@site/docs/display/development/development-flash_and_debug_firmware.md",sourceDirName:"display/development",slug:"/display/development/development-flash_and_debug_firmware",permalink:"/docs/display/development/development-flash_and_debug_firmware",draft:!1,editUrl:"https://github.com/opensource-ebike/site/tree/master/docs/display/development/development-flash_and_debug_firmware.md",tags:[],version:"current",frontMatter:{},sidebar:"displaySidebar",previous:{title:"Development",permalink:"/docs/display/development/"}},d={},p=[{value:"Software or configurations you need to install / do",id:"software-or-configurations-you-need-to-install--do",level:2},{value:"Open project folder with Visual Studio Code",id:"open-project-folder-with-visual-studio-code",level:2},{value:"Configure the code for development",id:"configure-the-code-for-development",level:2},{value:"Build the code",id:"build-the-code",level:2},{value:"Flash the firmware and debug",id:"flash-the-firmware-and-debug",level:2},{value:"Use OpenOCD to unlock / erase / flash the firmware",id:"use-openocd-to-unlock--erase--flash-the-firmware",level:2},{value:"Unlocking / removing flash protection",id:"unlocking--removing-flash-protection",level:3}],c={toc:p};function h(e){var t=e.components,i=(0,a.Z)(e,r);return(0,l.kt)("wrapper",(0,o.Z)({},c,i,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("h1",{id:"configure-code-studio-ide-for-firmware-development-flash-and-debug"},"Configure Code Studio IDE for firmware development, flash and debug"),(0,l.kt)("p",null,"For the firmware development, flash and debug, you can use the OpenSource and free IDE ",(0,l.kt)("a",{parentName:"p",href:"https://code.visualstudio.com/"},"Visual Studio Code"),". There are others that will work like the Eclipse but are not the focus of this document."),(0,l.kt)("p",null,"This guide assumes you are using Linux Ubuntu (if you are on Windows or MACOS you may find other guides on Internet but the concept will be the same). For Windows you may use the ",(0,l.kt)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/windows/wsl/"},"Linux on Windows"),"."),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"NOTES:")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"You can follow this notes both for debug a STM32 or a NRF52 microcontroller."),(0,l.kt)("li",{parentName:"ul"},"You can, buy on Aliexpress or Ebay, and use, a cheap JLink or STLinkV2. The JLINK is physically more robust and so is the recommend one."),(0,l.kt)("li",{parentName:"ul"},"The instructions on this guide were tested on Linux Ubuntu. If you have a Windows or MAC OS, you can search Internet for similar guides and adapt, and take this one as a reference.")),(0,l.kt)("h2",{id:"software-or-configurations-you-need-to-install--do"},"Software or configurations you need to install / do"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"add your user to the dialout group: ",(0,l.kt)("strong",{parentName:"li"},"sudo usermod -a -G dialout USER_NAME")," and reboot"),(0,l.kt)("li",{parentName:"ul"},"install ",(0,l.kt)("a",{parentName:"li",href:"https://code.visualstudio.com/"},"Visual Studio Code"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"install C/C++ extension (to edit C/C++ source files)"),(0,l.kt)("li",{parentName:"ul"},"install Cortex-Debug extension (to be able to debug ARM microcontroller)"),(0,l.kt)("li",{parentName:"ul"},"install Task Manager extension (to call make and other commands)"))),(0,l.kt)("li",{parentName:"ul"},"install OpenOCD (to connect to STLinkV2, note that simply ",(0,l.kt)("strong",{parentName:"li"},"sudo apt-get install openocd")," will install version 0.10.0 which is old, and will not flash nRF52 dongle):",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"sudo apt-get install npm")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"sudo npm install --global xpm@latest")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"xpm install --global @xpack-dev-tools/openocd@latest")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"sudo ln -s ~/.local/xPacks/@xpack-dev-tools/openocd/0.11.0-4.1/.content/bin/openocd /usr/bin/openocd")))),(0,l.kt)("li",{parentName:"ul"},"install GDB GNU debugger (for debug and connect to OpenOCD): ",(0,l.kt)("strong",{parentName:"li"},"sudo apt-get install gdb-multiarch")),(0,l.kt)("li",{parentName:"ul"},"install ARM C/C++ GCC compiler: ",(0,l.kt)("strong",{parentName:"li"},"sudo apt-get install gcc-arm-none-eabi")),(0,l.kt)("li",{parentName:"ul"},"install ARM binutils: ",(0,l.kt)("strong",{parentName:"li"},"sudo apt-get install binutils-arm-none-eabi")),(0,l.kt)("li",{parentName:"ul"},"install ARM newlib: ",(0,l.kt)("strong",{parentName:"li"},"sudo apt-get install libnewlib-arm-none-eabi")),(0,l.kt)("li",{parentName:"ul"},"install make tool: ",(0,l.kt)("strong",{parentName:"li"},"sudo apt-get install make")),(0,l.kt)("li",{parentName:"ul"},"install srec_cat tool (only needed for NRF52): ",(0,l.kt)("strong",{parentName:"li"},"sudo apt-get install srecord")),(0,l.kt)("li",{parentName:"ul"},"install nrfutil tool (only needed for NRF52): ",(0,l.kt)("strong",{parentName:"li"},"sudo pip3 install nrfutil"))),(0,l.kt)("h2",{id:"open-project-folder-with-visual-studio-code"},"Open project folder with Visual Studio Code"),(0,l.kt)("p",null,"Click on menu File -> Open folder... and select the firmware directory. You should see the firmware similar to this:"),(0,l.kt)("p",null,(0,l.kt)("img",{src:n(1432).Z,width:"770",height:"602"})),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"NOTES:")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Usually I keep the folder ",(0,l.kt)("em",{parentName:"li"},"tools")," with OpenOCD scritps inside the project folder and this files are needed for the OpenOCD to work:")),(0,l.kt)("p",null,(0,l.kt)("img",{src:n(4601).Z,width:"316",height:"466"})),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"The hiden folder ",(0,l.kt)("em",{parentName:"li"},".vscode")," must also be present inside the project folder, that will contain the ",(0,l.kt)("em",{parentName:"li"},"tasks.json")," with tasks configurations and ",(0,l.kt)("em",{parentName:"li"},"launch.json")," with OpenOCD debug session commands:")),(0,l.kt)("p",null,(0,l.kt)("img",{src:n(1710).Z,width:"239",height:"154"})),(0,l.kt)("h2",{id:"configure-the-code-for-development"},"Configure the code for development"),(0,l.kt)("p",null,"In the main.h file there are some settings that need to be updated to match your development hardware. All of them are at the top of the file:"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"uncomment ",(0,l.kt)("strong",{parentName:"li"},"#define DEVELOPMENT")," line"),(0,l.kt)("li",{parentName:"ol"},"in the ",(0,l.kt)("strong",{parentName:"li"},"#ifdef DEVELOPMENT")," section define the hardware you will be using for development:")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"first line is the display type: if you are using 1.3 inch display use ",(0,l.kt)("strong",{parentName:"li"},"#define DISPLAY_SH1106"),", for 0.96 inch display use ",(0,l.kt)("strong",{parentName:"li"},"#define DISPLAY_SSD1306")),(0,l.kt)("li",{parentName:"ul"},"second line is the display interfce: ",(0,l.kt)("strong",{parentName:"li"},"#define DISPLAY_SPI")," or ",(0,l.kt)("strong",{parentName:"li"},"DISPLAY_I2C"))),(0,l.kt)("h2",{id:"build-the-code"},"Build the code"),(0,l.kt)("p",null,"Because you installed the Task Manager extension, you should see Task manager icon on the left bar - click on it. The build, clean and Launch OpenOCD tasks should be available."),(0,l.kt)("p",null,"Start by clicking on the clean to clean the code and then click on the build to build the code and you should see something similar to this - note the output on the terminal:"),(0,l.kt)("p",null,(0,l.kt)("img",{src:n(6339).Z,width:"1670",height:"1079"})),(0,l.kt)("p",null,"NOTE: The tasks will only be visible if they are configured on the .vscode/tasks.json."),(0,l.kt)("p",null,"The clean and build tasks simple call the ",(0,l.kt)("strong",{parentName:"p"},"make clean")," and ",(0,l.kt)("strong",{parentName:"p"},"make")," on the terminal. You can call the ",(0,l.kt)("strong",{parentName:"p"},"make clean")," and ",(0,l.kt)("strong",{parentName:"p"},"make")," on the terminal to check that they work (make uses the Makefile that you will find on the project source folder)."),(0,l.kt)("h2",{id:"flash-the-firmware-and-debug"},"Flash the firmware and debug"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"Connect the STLinkV2 to the board. If you have a nRF52840 MDK Dongle see the pinout in the schematic folder. If you have the blue nRF52840 Dongle it has a different pinout, see ",(0,l.kt)("a",{target:"_blank",href:n(80).Z},"nRF52840 Dongle Pinout.png"),", note that you do not need to connect the RST pin.")),(0,l.kt)("p",null,"Note that you will also need to install the STLinkV2 udev rules file that are on the ",(0,l.kt)("em",{parentName:"p"},"tools")," folder, so the STLinkV2 can be accessed by the OpenOCD:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"sudo cp 60-st_link_v2.rules /etc/udev/rules.d\nsudo udevadm control --reload-rules\n")),(0,l.kt)("ol",{start:2},(0,l.kt)("li",{parentName:"ol"},"Click on the task Launch OpenOCD")),(0,l.kt)("p",null,"You will need to click only once. The OpenOCD should connect to the microcontroller and keep active - see the example output of OpenOCD on the terminal, when a correct connection was done with the microcontroller:"),(0,l.kt)("p",null,(0,l.kt)("img",{src:n(6334).Z,width:"1423",height:"1080"})),(0,l.kt)("p",null,"The task Launch OpenOCD configuration is on the file .vscode/tasks.json."),(0,l.kt)("ol",{start:3},(0,l.kt)("li",{parentName:"ol"},"Click NRF52 Flash and Debug")),(0,l.kt)("p",null,"Click on the debug icon on the left panel and then click on the small green arrow for the NRF52 Flash and Debug - will flash the firmware on the microcontroller and then start the debug of the firmware.. Wait a few seconds and you should see something like this:"),(0,l.kt)("p",null,(0,l.kt)("img",{src:n(5772).Z,width:"1920",height:"1080"})),(0,l.kt)("p",null,"The NRF52 Flash and Debug configuration is on the file .vscode/launch.json."),(0,l.kt)("h2",{id:"use-openocd-to-unlock--erase--flash-the-firmware"},"Use OpenOCD to unlock / erase / flash the firmware"),(0,l.kt)("p",null,"To make sure you can flash the firmware correctly, it always help to make sure a full erase is done first. Sometimes, the flash memory is fully or partially locked (some sectors locked) and must be unlocked first of a full erase."),(0,l.kt)("p",null,"The idea is that you start OpenOCD (click on the Visual Code Studio task Launch OpenOCD) and then you open a terminal and connect by telnet:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"sudo telnet localhost 4444\n")),(0,l.kt)("p",null,'You should execute "help" on the OpenOCD terminal to see which are the possible commands of your interest and read the instructions for each command:'),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"help\n")),(0,l.kt)("p",null,"For instance, here is the sequence to initialize the microcontroller:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"init\nreset halt\n")),(0,l.kt)("p",null,"Then to erase the microcontroller (not needed on STM32F103):"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"nrf5 mass_erase\n")),(0,l.kt)("p",null,"The next command will flash the firmware:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"flash write_image erase ABSOLUTE_PATH_TO_FIRMWARE_ON_YOUR_PC/FIRMWARE.hex\n")),(0,l.kt)("p",null,"The next commands will initialize the microcontroller and so you can now start debugging on Visual Code Studio:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"reset halt\n")),(0,l.kt)("h3",{id:"unlocking--removing-flash-protection"},"Unlocking / removing flash protection"),(0,l.kt)("p",null,"If you are using a STM32F103, the very first time you use it, you may need to unlock it with the following OpenOCD commands:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"init\nreset halt\nstm32f1x unlock 0\nreset halt\n")),(0,l.kt)("p",null,"For NRF52 (",(0,l.kt)("a",{parentName:"p",href:"https://blog.dbrgn.ch/2020/5/16/nrf52-unprotect-flash-jlink-openocd/"},"taken from this guide"),"):"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"dap apreg 1 0x04 0x01\n")))}h.isMDXComponent=!0},80:function(e,t,n){t.Z=n.p+"assets/files/nRF52840_Dongle_Pinout-718aab92a1627aeba2cf466554049c3a.png"},1432:function(e,t,n){t.Z=n.p+"assets/images/flash_debug_1-da95d8fa253fffe68598eb70d3639cd0.png"},6339:function(e,t,n){t.Z=n.p+"assets/images/flash_debug_2-ae6dd55b3e91e911dd498894fc065eb7.png"},6334:function(e,t,n){t.Z=n.p+"assets/images/flash_debug_3-c45bfdae5e1cc6730fedcd951a8dfac4.png"},5772:function(e,t,n){t.Z=n.p+"assets/images/flash_debug_4-e0169e0e93706e5a5b0cd87af730e4ee.png"},4601:function(e,t,n){t.Z=n.p+"assets/images/tools_folder-14e2154c9496f6325434119259e02f58.png"},1710:function(e,t,n){t.Z=n.p+"assets/images/vscode_folder-4d422ba0992822504ca7fcb49c966e3a.png"}}]);