"use strict";(self.webpackChunkdocusaurus=self.webpackChunkdocusaurus||[]).push([[2207],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return d}});var r=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=r.createContext({}),c=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},u=function(e){var t=c(e.components);return r.createElement(l.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},p=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,l=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),p=c(n),d=o,f=p["".concat(l,".").concat(d)]||p[d]||m[d]||a;return n?r.createElement(f,s(s({ref:t},u),{},{components:n})):r.createElement(f,s({ref:t},u))}));function d(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,s=new Array(a);s[0]=p;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i.mdxType="string"==typeof e?e:o,s[1]=i;for(var c=2;c<a;c++)s[c]=n[c];return r.createElement.apply(null,s)}return r.createElement.apply(null,n)}p.displayName="MDXCreateElement"},7356:function(e,t,n){n.r(t),n.d(t,{assets:function(){return u},contentTitle:function(){return l},default:function(){return d},frontMatter:function(){return i},metadata:function(){return c},toc:function(){return m}});var r=n(3117),o=n(102),a=(n(7294),n(3905)),s=["components"],i={},l=void 0,c={unversionedId:"tsdz2/Improved-communications-protocol",id:"tsdz2/Improved-communications-protocol",title:"Improved-communications-protocol",description:"See discussion here:",source:"@site/docs/tsdz2/Improved-communications-protocol.md",sourceDirName:"tsdz2",slug:"/tsdz2/Improved-communications-protocol",permalink:"/docs/tsdz2/Improved-communications-protocol",draft:!1,editUrl:"https://github.com/OpenSourceEBike/OpenSourceEBike.github.io/tree/master/docs/tsdz2/Improved-communications-protocol.md",tags:[],version:"current",frontMatter:{},sidebar:"tsdz2Sidebar",previous:{title:"How-to-install-the-Flexible-OpenSource-firmware",permalink:"/docs/tsdz2/How-to-install-the-Flexible-OpenSource-firmware"},next:{title:"Interesting-forks-and-projects",permalink:"/docs/tsdz2/Interesting-forks-and-projects"}},u={},m=[{value:"Commands",id:"commands",level:2},{value:"Answer",id:"answer",level:2},{value:"Schematic",id:"schematic",level:2}],p={toc:m};function d(e){var t=e.components,n=(0,o.Z)(e,s);return(0,a.kt)("wrapper",(0,r.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"See discussion here:\n",(0,a.kt)("a",{parentName:"p",href:"https://github.com/OpenSource-EBike-firmware/TSDZ2-Smart-EBike/issues/125"},"https://github.com/OpenSource-EBike-firmware/TSDZ2-Smart-EBike/issues/125")),(0,a.kt)("p",null,"Motor controller side limitations:"),(0,a.kt)("p",null,"-"," the memory is VERY limited (we have free only 6K bytes from total of\n32 kbytes and there are other important features as full torque sensor\ncalibration to be done and a wish for better high cadence mode). Let\xb4s\nnot forget that original firmware even uses only 16 kbytes of flash\nmemory, that should be the official microcontroller memory amount."),(0,a.kt)("p",null,"-"," it is very slow and has no interrupts when it sends data to the\ndisplay so it hangs waiting for full send. The processing power should\nmainly be dedicated to the motor control and so keep a good energy\nefficiency for FOC / battery range"),(0,a.kt)("h1",{id:"needs"},"Needs"),(0,a.kt)("p",null,"-"," configurations data will increase more at least 40 bytes for the\ntorque sensor full calibration (10 points for each pedal, 2 bytes for\neach point) and so they need to be sent at least one at startup and\nevery time they change, with a confirmation the motor controller\nreceived it. The motor controller should not start the motor until\nreceive at least once the configurations."),(0,a.kt)("p",null,"-"," motor controller firmware version"),(0,a.kt)("h1",{id:"protocol"},"Protocol"),(0,a.kt)("p",null,"Display is the master and can send commands to the slave motor\ncontroller. Although there is an exception: the slave sends periodically\nat every 100ms a package to master and master then sends an answer in\nresponse. The data exchange on this periodically command and answer, is\nconsidered important and needed to be sent at this periodically rate of\n100ms.\\\nWhen the slave sends the answer of a command, the next periodically\npackage is not sent but is sent instead the answer package."),(0,a.kt)("h2",{id:"commands"},"Commands"),(0,a.kt)("p",null,"+---------------------+----------------------+----------------------+\n| ID number\\          | Name                 | description          |\n| (type of the frame) |                      |                      |\n+=====================+======================+======================+\n| 0                   | periodically command |                      |\n|                     | (sent only as answer |                      |\n|                     | to the received      |                      |\n|                     | periodically         |                      |\n|                     | answer!)             |                      |\n+---------------------+----------------------+----------------------+\n| 1                   | configurations       | full configurations  |\n|                     |                      | stream               |\n+---------------------+----------------------+----------------------+\n| 2                   | controller firmware  | get the motor        |\n|                     | version              | controller firmware  |\n|                     |                      | version              |\n+---------------------+----------------------+----------------------+"),(0,a.kt)("h2",{id:"answer"},"Answer"),(0,a.kt)("p",null,"+---------------------+----------------------+----------------------+\n| Answer ID\\          | Name                 | Notes                |\n| (type of the frame) |                      |                      |\n+=====================+======================+======================+\n| 0                   | periodically answer  | ","["," 0 ","]","\\             |\n|                     | (sent automatically  | ","[","x","]"," motor          |\n|                     | by the initiative of | controller status    |\n|                     | the slave!)          | (first 8 bits)\\      |\n|                     |                      | ","[","x","]"," motor          |\n|                     |                      | controller status    |\n|                     |                      | (last 8 bits)\\       |\n|                     |                      | ","[","x","]"," battery        |\n|                     |                      | voltage 10 bits      |\n|                     |                      | (first 8 bits)\\      |\n|                     |                      | ","[","x","]"," battery        |\n|                     |                      | current (6 bits) +   |\n|                     |                      | battery voltage 10   |\n|                     |                      | bits (last 2 bits)\\  |\n|                     |                      | ","[","x","]"," motor phase    |\n|                     |                      | current (6 bits)\\    |\n|                     |                      | ","[","x","]"," wheel speed    |\n|                     |                      | X10 (fist 8 bits)\\   |\n|                     |                      | ","[","x","]"," wheel speed    |\n|                     |                      | X10 (last 8 bits)\\   |\n|                     |                      | ","[","x","]"," brake state +  |\n|                     |                      | hall sensors state   |\n|                     |                      | (3 bits) + pedal     |\n|                     |                      | position\\            |\n|                     |                      | ","[","x","]"," throttle ADC   |\n|                     |                      | value\\               |\n|                     |                      | ","[","x","]"," throttle value |\n|                     |                      | or motor temperature |\n|                     |                      | value\\               |\n|                     |                      | ","[","x","]"," torque sensor  |\n|                     |                      | ADC value\\           |\n|                     |                      | ","[","x","]"," torque sensor  |\n|                     |                      | weight value\\        |\n|                     |                      | ","[","x","]"," cadence\\       |\n|                     |                      | ","[","x","]"," pedal power    |\n|                     |                      | (fist 8 bits)\\       |\n|                     |                      | ","[","x","]"," pedal power    |\n|                     |                      | (last 8 bits)\\       |\n|                     |                      | ","[","x","]"," motor PWM      |\n|                     |                      | duty-cycle\\          |\n|                     |                      | ","[","x","]"," motor speed in |\n|                     |                      | ERPS (fist 8 bits)\\  |\n|                     |                      | ","[","x","]"," motor speed in |\n|                     |                      | ERPS (last 8 bits)\\  |\n|                     |                      | ","[","x","]"," motor FOC      |\n|                     |                      | angle\\               |\n|                     |                      | ","[","x","]"," motor          |\n|                     |                      | temperature actual   |\n|                     |                      | limiting value\\      |\n|                     |                      | ","[","x","]"," wheel speed    |\n|                     |                      | tick counter (fist 8 |\n|                     |                      | bits)\\               |\n|                     |                      | ","[","x","]"," wheel speed    |\n|                     |                      | tick counter (middle |\n|                     |                      | 8 bits)\\             |\n|                     |                      | ","[","x","]"," wheel speed    |\n|                     |                      | tick counter (last 8 |\n|                     |                      | bits)\\               |\n+---------------------+----------------------+----------------------+\n| 1                   | configurations       | ","["," 1 ","]"," means the    |\n|                     |                      | command was          |\n|                     |                      | received, we should  |\n|                     |                      | consider all went ok |\n+---------------------+----------------------+----------------------+\n| 2                   | controller firmware  | ","["," 2 ","]"," means the    |\n|                     | version              | command was          |\n|                     |                      | received\\            |\n|                     |                      | ","["," x ","]"," ","["," x ","]"," ","["," x |\n|                     |                      | ","]"," version, example  |\n|                     |                      | 0.5.1.               |\n+---------------------+----------------------+----------------------+"),(0,a.kt)("h2",{id:"schematic"},"Schematic"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Motor controller to display")),(0,a.kt)("p",null,"  Byte number   Name              Value   Notes"),(0,a.kt)("hr",null),(0,a.kt)("p",null,"  1             start byte        0x43    always the same\n2             length of frame   xx      all following bytes\n3             type of frame     xx",(0,a.kt)("br",{parentName:"p"}),"\n","4             payload           xx      including CRC always at the end"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Display to motor controller")),(0,a.kt)("p",null,"  Byte number   Name              Value   Notes"),(0,a.kt)("hr",null),(0,a.kt)("p",null,"  1             start byte        0x59    always the same\n2             length of frame   xx      all following bytes\n3             type of frame     xx",(0,a.kt)("br",{parentName:"p"}),"\n","4             payload           xx      including CRC always at the end"))}d.isMDXComponent=!0}}]);